<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BalanÃ§o Financeiro Mensal</title>
    <style>
        /* CSS GERAL */
        body { font-family: Arial, sans-serif; background-color: #f9f9f9; margin: 0; padding: 0; color: #333; }
        header { text-align: center; background-color: #212121; color: #fff; padding: 20px; margin-bottom: 20px; }
        header h1 { margin: 0; font-size: 24px; }
        header p { margin: 5px 0; font-size: 14px; }
        .container { width: 95%; max-width: 1200px; margin: 0 auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }
        .section-title { font-weight: bold; margin-top: 30px; text-align: center; font-size: 18px; color: #212121; }
        table { width: 100%; border-collapse: collapse; margin: 20px auto 10px auto; font-size: 14px; text-align: center; }
        th, td { border: 1px solid #ddd; text-align: center; padding: 8px; vertical-align: middle; }
        th { background-color: #212121; font-weight: bold; color: #fff; }
        td input, td textarea { width: 90%; padding: 6px; font-size: 14px; border: 1px solid #ccc; border-radius: 4px; text-align: center; }
        
        .btn-trash { background-color: #e53935; color: white; border: none; border-radius: 4px; padding: 6px 10px; cursor: pointer; font-size: 16px; line-height: 1; }
        .btn-trash:hover { background-color: #b71c1c; }
        .btn-container { text-align: center; margin-top: 10px; }
        .btn { display: inline-block; background-color: #212121; color: white; padding: 10px 15px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; }
        .btn-sort { background-color: #FF9800; }
        .btn:hover { opacity: 0.9; }

        .import-section { background-color: #f1f1f1; border: 1px solid #ccc; padding: 15px; border-radius: 8px; margin-top: 10px; display: none; }
        .import-grid { display: flex; gap: 15px; flex-wrap: wrap; }
        .import-col { flex: 1; min-width: 250px; }
        
        .balance-header { text-align: center; margin-bottom: 20px; }
        .balance-inputs-container { display: flex; flex-direction: column; align-items: center; gap: 10px; margin-bottom: 20px; }
        .balance-input-group { display: flex; align-items: center; gap: 10px; }
        .balance-input-group label { width: 180px; text-align: right; font-weight: bold; }
        
        .totals { text-align: center; font-size: 16px; margin-top: 20px; }
        .totals span { font-weight: bold; color: #000; cursor: pointer; text-decoration: underline; }
        .totals-table { margin: 0 auto; width: 90%; border: 1px solid #ddd; margin-top: 20px; font-size: 14px; text-align: center; }
        .totals-table td { border: 1px solid #ddd; padding: 8px; font-size: 14px; text-align: center; }
        
        /* Modais */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fff; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 500px; border-radius: 8px; text-align: center; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        
        .avoid-page-break { page-break-inside: avoid; break-inside: avoid; }
        .pdf-summary-style { margin-bottom: 30px; border: 2px solid #333; padding: 10px; }

        @media only screen and (max-width: 600px) {
            body { margin: 0; padding: 0; width: 100%; overflow-x: hidden; }
            .container { width: 100%; padding: 10px; }
            table { font-size: 12px; display: block; overflow-x: auto; }
            .balance-input-group { flex-direction: column; gap: 5px; }
            .balance-input-group label { width: 100%; text-align: center; }
        }

        @media print {
            .no-print { display: none !important; }
            table, tr, td, th { page-break-inside: avoid; }
            section, .balance-header, .totals { page-break-inside: avoid; }
            /* SÃ³ esconde a coluna de aÃ§Ãµes nas tabelas de receitas e despesas na impressÃ£o */
            #receitasTable th:last-child,
            #receitasTable td:last-child,
            #despesasTable th:last-child,
            #despesasTable td:last-child {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div id="exportContent">
        <header class="avoid-page-break">
            <h1>BalanÃ§o Financeiro Mensal</h1>
            <p>Instituto PE. Paulo Canelles do Recife</p>
            <p>CNPJ: 11.500.204/0001-08</p>
        </header>

        <main class="container">
            <div class="no-print avoid-page-break" style="margin-bottom: 25px;">
                <button class="btn" id="toggleImportBtn" style="background-color: #2e7d32; width: 100%;">ðŸ“‚ Importar Dados (Colar)</button>
                <div id="importPanel" class="import-section">
                    <p style="font-size: 13px; margin-bottom: 10px; text-align: center;">
                        <strong>InstruÃ§Ãµes:</strong> Copie do Excel e cole abaixo. Formato: <code>DATA ; DESCRIÃ‡ÃƒO ; VALOR</code>
                    </p>
                    <div class="import-grid">
                        <div class="import-col">
                            <label>Colar Receitas:</label>
                            <textarea id="importReceitasInput" rows="6" style="width: 100%; box-sizing: border-box;"></textarea>
                        </div>
                        <div class="import-col">
                            <label>Colar Despesas:</label>
                            <textarea id="importDespesasInput" rows="6" style="width: 100%; box-sizing: border-box;"></textarea>
                        </div>
                    </div>
                    <div class="btn-container" style="text-align: right; margin-top: 15px;">
                        <button class="btn" id="processImportBtn" style="background-color: #1976d2;">Adicionar e Ordenar</button>
                    </div>
                </div>
            </div>

            <div class="balance-header no-print avoid-page-break">
                <label for="month">MÃªs:</label>
                <select id="month">
                    <option value="Janeiro">Janeiro</option>
                    <option value="Fevereiro">Fevereiro</option>
                    <option value="MarÃ§o">MarÃ§o</option>
                    <option value="Abril">Abril</option>
                    <option value="Maio">Maio</option>
                    <option value="Junho">Junho</option>
                    <option value="Julho">Julho</option>
                    <option value="Agosto">Agosto</option>
                    <option value="Setembro">Setembro</option>
                    <option value="Outubro">Outubro</option>
                    <option value="Novembro" selected>Novembro</option>
                    <option value="Dezembro">Dezembro</option>
                </select>
                <label for="year">Ano:</label>
                <input type="number" id="year" placeholder="2024" value="2024" min="1900" max="2100">
                <button class="btn" id="updateButton">Atualizar TÃ­tulo</button>
            </div>

            <section class="avoid-page-break">
                <div id="balanceTitle" class="section-title">Balancete Mensal - Novembro 2024</div>
                
                <div class="balance-header">
                    <div class="balance-inputs-container">
                        <div class="balance-input-group">
                            <label for="saldoAnterior">Saldo Anterior (banco):</label>
                            <input type="text" id="saldoAnterior" placeholder="R$ 0,00">
                        </div>
                        <div class="balance-input-group">
                            <label for="saldoAnteriorCaixa">Saldo Anterior (caixa):</label>
                            <input type="text" id="saldoAnteriorCaixa" placeholder="R$ 0,00">
                        </div>
                    </div>
                </div>
            </section>

            <section id="sectionReceitas" class="avoid-page-break">
                <div class="section-title">RECEITAS</div>
                <table id="receitasTable">
                    <thead>
                        <tr>
                            <th style="width: 20%;">DATA</th>
                            <th style="width: 50%;">DESCRIÃ‡ÃƒO</th>
                            <th style="width: 20%;">VALOR</th>
                            <th class="no-print" style="width: 10%;">AÃ‡Ã•ES</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><input type="date"></td>
                            <td><input type="text" placeholder="DescriÃ§Ã£o"></td>
                            <td><input type="text" class="valor" placeholder="R$ 0,00"></td>
                            <td class="no-print"><button class="btn-trash" onclick="deleteRow(this)">ðŸ—‘</button></td>
                        </tr>
                    </tbody>
                </table>
                <div class="btn-container no-print">
                    <button class="btn" id="addReceita">Adicionar Linha</button>
                    <button class="btn btn-sort" id="sortReceitas">â¬‡ Ordenar por Data</button>
                </div>
            </section>

            <section class="avoid-page-break">
                <div class="section-title">DESPESAS</div>
                <table id="despesasTable">
                    <thead>
                        <tr>
                            <th style="width: 20%;">DATA</th>
                            <th style="width: 50%;">DESCRIÃ‡ÃƒO</th>
                            <th style="width: 20%;">VALOR</th>
                            <th class="no-print" style="width: 10%;">AÃ‡Ã•ES</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><input type="date"></td>
                            <td><input type="text" placeholder="DescriÃ§Ã£o"></td>
                            <td><input type="text" class="valor" placeholder="R$ 0,00"></td>
                            <td class="no-print"><button class="btn-trash" onclick="deleteRow(this)">ðŸ—‘</button></td>
                        </tr>
                    </tbody>
                </table>
                <div class="btn-container no-print">
                    <button class="btn" id="addDespesa">Adicionar Linha</button>
                    <button class="btn btn-sort" id="sortDespesas">â¬‡ Ordenar por Data</button>
                </div>
            </section>

            <section id="sectionTotals" class="totals avoid-page-break">
                <table class="totals-table">
                    <tr>
                        <td><span data-modal="saldoAnteriorModal">Saldo Anterior Total (Banco + Caixa):</span></td>
                        <td><span id="saldoAnteriorDisplay">R$ 0,00</span></td>
                    </tr>
                    <tr>
                        <td><span data-modal="totalReceitasModal">Total de Receitas:</span></td>
                        <td><span id="totalReceitas">R$ 0,00</span></td>
                    </tr>
                    <tr>
                        <td><span data-modal="totalDespesasModal">Total de Despesas:</span></td>
                        <td><span id="totalDespesas">R$ 0,00</span></td>
                    </tr>
                    <tr>
                        <td><span data-modal="saldoAtualModal">Saldo Atual:</span></td>
                        <td><span id="saldoAtual">R$ 0,00</span></td>
                    </tr>
                </table>
                <div class="btn-container no-print">
                    <button class="btn" id="exportButton">Exportar PDF</button>
                </div>
            </section>
        </main>
    </div>

    <div id="saldoAnteriorModal" class="modal"><div class="modal-content"><span class="close" data-close="saldoAnteriorModal">&times;</span><p>Soma dos saldos em Banco e Caixa.</p></div></div>
    <div id="totalReceitasModal" class="modal"><div class="modal-content"><span class="close" data-close="totalReceitasModal">&times;</span><p>Soma das receitas.</p></div></div>
    <div id="totalDespesasModal" class="modal"><div class="modal-content"><span class="close" data-close="totalDespesasModal">&times;</span><p>Soma das despesas.</p></div></div>
    <div id="saldoAtualModal" class="modal"><div class="modal-content"><span class="close" data-close="saldoAtualModal">&times;</span><p>Saldo Anterior + Receitas - Despesas.</p></div></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const updateButton = document.getElementById('updateButton');
            const saldoAnteriorInput = document.getElementById('saldoAnterior');
            const saldoAnteriorCaixaInput = document.getElementById('saldoAnteriorCaixa');
            const addReceitaButton = document.getElementById('addReceita');
            const sortReceitasButton = document.getElementById('sortReceitas');
            const addDespesaButton = document.getElementById('addDespesa');
            const sortDespesasButton = document.getElementById('sortDespesas');
            const exportButton = document.getElementById('exportButton');
            const toggleImportBtn = document.getElementById('toggleImportBtn');
            const processImportBtn = document.getElementById('processImportBtn');

            updateButton.addEventListener('click', updateBalanceTitle);
            
            [saldoAnteriorInput, saldoAnteriorCaixaInput].forEach(el => {
                el.addEventListener('input', calculateTotals);
                el.addEventListener('blur', () => formatCurrency(el));
                el.addEventListener('keydown', handleEnterKey);
            });

            addReceitaButton.addEventListener('click', () => addRow('receitasTable'));
            sortReceitasButton.addEventListener('click', () => sortTableByDate('receitasTable'));
            addDespesaButton.addEventListener('click', () => addRow('despesasTable'));
            sortDespesasButton.addEventListener('click', () => sortTableByDate('despesasTable'));
            
            exportButton.addEventListener('click', exportData);

            toggleImportBtn.addEventListener('click', () => {
                const panel = document.getElementById('importPanel');
                panel.style.display = (panel.style.display === 'block') ? 'none' : 'block';
                toggleImportBtn.textContent = (panel.style.display === 'block') ? 'âŒ Fechar ImportaÃ§Ã£o' : 'ðŸ“‚ Importar Dados (Colar)';
            });

            processImportBtn.addEventListener('click', processImportData);

            attachTableEvents('receitasTable');
            attachTableEvents('despesasTable');
            attachModalEvents();
            updateBalanceTitle();
        });

        window.deleteRow = function(btn) {
            const row = btn.closest('tr');
            const tableBody = row.parentNode;
            const tableId = tableBody.closest('table').id;
            row.remove();
            if (tableBody.rows.length === 0) addRow(tableId);
            calculateTotals();
        };

        function sortTableByDate(tableId) {
            const tableBody = document.getElementById(tableId).querySelector('tbody');
            const rows = Array.from(tableBody.querySelectorAll('tr'));
            rows.sort((a, b) => {
                const valA = a.querySelector('input[type="date"]')?.value || '';
                const valB = b.querySelector('input[type="date"]')?.value || '';
                if (valA === valB) return 0;
                return valA === '' ? 1 : (valB === '' ? -1 : valA.localeCompare(valB));
            });
            rows.forEach(row => tableBody.appendChild(row));
        }

        function processImportData() {
            const r = document.getElementById('importReceitasInput').value;
            const d = document.getElementById('importDespesasInput').value;
            if (!r.trim() && !d.trim()) { alert("Cole dados em pelo menos um campo."); return; }
            if (r.trim()) parseAndPopulate(r, 'receitasTable');
            if (d.trim()) parseAndPopulate(d, 'despesasTable');
            sortTableByDate('receitasTable');
            sortTableByDate('despesasTable');
            calculateTotals();
            document.getElementById('importReceitasInput').value = '';
            document.getElementById('importDespesasInput').value = '';
            document.getElementById('importPanel').style.display = 'none';
            document.getElementById('toggleImportBtn').textContent = 'ðŸ“‚ Importar Dados (Colar)';
            alert("Dados importados!");
        }

        function parseAndPopulate(text, tableId) {
            const tableBody = document.getElementById(tableId).querySelector('tbody');
            const firstRow = tableBody.rows[0];
            const inputs = firstRow ? firstRow.querySelectorAll('input') : [];
            if (tableBody.rows.length === 1 && inputs.length > 0 && !inputs[1].value && !inputs[2].value) tableBody.deleteRow(0);

            text.split(/\r?\n/).forEach(line => {
                if (!line.trim()) return;
                let parts = line.split(/;|\t/);
                if (parts.length >= 2) {
                    const row = tableBody.insertRow(-1);
                    const cellD = row.insertCell(0);
                    const inpD = document.createElement('input'); inpD.type='date';
                    if (parts[0].match(/\d/) && parts.length >= 3) inpD.value = convertToISODate(parts[0].trim());
                    cellD.appendChild(inpD);
                    
                    const cellDesc = row.insertCell(1);
                    const inpDesc = document.createElement('input'); inpDesc.type='text';
                    let descIdx = parts.length >= 3 ? 1 : 0;
                    inpDesc.value = parts[descIdx] ? parts[descIdx].trim() : '';
                    cellDesc.appendChild(inpDesc);

                    const cellVal = row.insertCell(2);
                    const inpVal = document.createElement('input'); inpVal.type='text'; inpVal.className='valor';
                    let valIdx = parts.length >= 3 ? 2 : 1;
                    let rawVal = parts[valIdx] ? parts[valIdx].trim() : '0';
                    inpVal.value = parseImportedValueToFloat(rawVal).toLocaleString('pt-BR', {minimumFractionDigits: 2});
                    cellVal.appendChild(inpVal);

                    const cellAct = row.insertCell(3); cellAct.className='no-print';
                    cellAct.innerHTML = '<button class="btn-trash" onclick="deleteRow(this)">ðŸ—‘</button>';
                }
            });
        }

        function parseImportedValueToFloat(v) {
            if(!v) return 0; v=v.replace(/R\$|\s/g,'');
            const c=v.lastIndexOf(','), d=v.lastIndexOf('.');
            if(c>d) v=v.replace(/\./g,'').replace(',','.');
            else if(d>c) v=v.replace(/,/g,'');
            return parseFloat(v)||0;
        }

        function convertToISODate(d) {
            const p = d.split(/[\/\-\.]/);
            if(p.length===3) {
                let y=p[2]; if(y.length===2) y='20'+y;
                return `${y}-${p[1].padStart(2,'0')}-${p[0].padStart(2,'0')}`;
            }
            return '';
        }

        function attachTableEvents(tid) {
            const t = document.getElementById(tid);
            t.addEventListener('input', e => { if(e.target.matches('input.valor')) calculateTotals(); });
            t.addEventListener('blur', e => { if(e.target.matches('input.valor')) formatCurrency(e.target); }, true);
            t.addEventListener('keydown', e => { if(e.target.matches('input') && e.key==='Enter') { e.preventDefault(); handleEnterInTable(e, tid); } });
        }

        function handleEnterInTable(e, tid) {
            const inputs = Array.from(document.querySelectorAll(`#${tid} tbody input`));
            const idx = inputs.indexOf(e.target);
            if(idx >= 0 && idx < inputs.length-1) inputs[idx+1].focus();
            else { addRow(tid); document.querySelector(`#${tid} tbody tr:last-child input`).focus(); }
        }

        function handleEnterKey(e) { if(e.key==='Enter') { e.preventDefault(); formatCurrency(e.target); } }

        function addRow(tid) {
            const r = document.getElementById(tid).querySelector('tbody').insertRow();
            r.insertCell(0).innerHTML = '<input type="date">';
            r.insertCell(1).innerHTML = '<input type="text" placeholder="DescriÃ§Ã£o">';
            r.insertCell(2).innerHTML = '<input type="text" class="valor" placeholder="R$ 0,00">';
            const c = r.insertCell(3); c.className = 'no-print';
            c.innerHTML = '<button class="btn-trash" onclick="deleteRow(this)">ðŸ—‘</button>';
        }

        function updateBalanceTitle() {
            const m = document.getElementById('month').value;
            const y = document.getElementById('year').value || new Date().getFullYear();
            document.getElementById('balanceTitle').textContent = `Balancete Mensal - ${m} ${y}`;
        }

        function formatCurrency(input) {
            let v = input.value;
            if(typeof v==='string') v=v.replace(/\s/g,'').replace('R$','').replace(/\./g,'').replace(',','.');
            const n = parseFloat(v);
            input.value = !isNaN(n) ? n.toLocaleString('pt-BR', {style:'currency', currency:'BRL'}) : 'R$ 0,00';
            calculateTotals();
        }

        function parseCurrency(v) {
            if(typeof v==='string') v=v.replace(/\s/g,'').replace('R$','').replace(/\./g,'').replace(',','.');
            return parseFloat(v)||0;
        }

        function calculateTotals() {
            const sb = parseCurrency(document.getElementById('saldoAnterior').value);
            const sc = parseCurrency(document.getElementById('saldoAnteriorCaixa').value);
            const st = sb + sc;
            let tr=0, td=0;
            document.querySelectorAll('#receitasTable tbody input.valor').forEach(i => tr += parseCurrency(i.value));
            document.querySelectorAll('#despesasTable tbody input.valor').forEach(i => td += parseCurrency(i.value));
            
            document.getElementById('saldoAnteriorDisplay').textContent = st.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
            document.getElementById('totalReceitas').textContent = tr.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
            document.getElementById('totalDespesas').textContent = td.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
            const atual = st + tr - td;
            const el = document.getElementById('saldoAtual');
            el.textContent = atual.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
            el.style.color = atual < 0 ? 'red' : 'green';
        }

        function exportData() {
            // 1. Garante formataÃ§Ã£o antes de clonar
            document.querySelectorAll('input.valor, #saldoAnterior, #saldoAnteriorCaixa').forEach(i => {
                if(i.value.trim() !== '') formatCurrency(i);
            });
            calculateTotals();

            // 2. CAPTURA OS VALORES REAIS DA TELA
            const realValues = {
                saldoAntDisplay: document.getElementById('saldoAnteriorDisplay').innerText,
                totalRec: document.getElementById('totalReceitas').innerText,
                totalDesp: document.getElementById('totalDespesas').innerText,
                saldoAtual: document.getElementById('saldoAtual').innerText,
                inputBanco: document.getElementById('saldoAnterior').value,
                inputCaixa: document.getElementById('saldoAnteriorCaixa').value
            };

            // 3. CLONA
            const element = document.getElementById('exportContent').cloneNode(true);

            // 4. INJETA OS VALORES CAPTURADOS NO CLONE (TOTAIS)
            element.querySelector('#saldoAnteriorDisplay').innerText = realValues.saldoAntDisplay;
            element.querySelector('#totalReceitas').innerText = realValues.totalRec;
            element.querySelector('#totalDespesas').innerText = realValues.totalDesp;
            element.querySelector('#saldoAtual').innerText = realValues.saldoAtual;

            // 5. INJETA OS VALORES NOS INPUTS DE SALDO (HEADER)
            const inputBancoClone = element.querySelector('#saldoAnterior');
            if(inputBancoClone) {
                const span = document.createElement('span');
                span.innerText = realValues.inputBanco;
                inputBancoClone.parentNode.replaceChild(span, inputBancoClone);
            }
            const inputCaixaClone = element.querySelector('#saldoAnteriorCaixa');
            if(inputCaixaClone) {
                const span = document.createElement('span');
                span.innerText = realValues.inputCaixa;
                inputCaixaClone.parentNode.replaceChild(span, inputCaixaClone);
            }

            // 6. REORGANIZA O LAYOUT PARA O PDF (MOVER TOTAIS PARA O TOPO)
            const sectionTotals = element.querySelector('#sectionTotals');
            const sectionReceitas = element.querySelector('#sectionReceitas');
            
            if(sectionTotals && sectionReceitas) {
                sectionReceitas.parentNode.insertBefore(sectionTotals, sectionReceitas);
                sectionTotals.style.marginBottom = '20px';
                sectionTotals.style.border = '1px solid #ddd';
                sectionTotals.style.padding = '10px';
            }

            // 7. CONVERTE INPUTS DAS TABELAS EM TEXTO
            const clonedInputs = element.querySelectorAll('input, select');
            clonedInputs.forEach(input => {
                const span = document.createElement('span');
                if (input.type === 'date' && input.value) {
                    const [y, m, d] = input.value.split('-');
                    span.innerText = `${d}/${m}/${y}`;
                } else if (input.tagName === 'SELECT') {
                    span.innerText = input.options[input.selectedIndex].text;
                } else {
                    span.innerText = input.value;
                }
                input.parentNode.replaceChild(span, input);
            });

            // 8. REMOVE ITENS DESNECESSÃRIOS
            element.querySelectorAll('.no-print, .btn, .btn-trash').forEach(el => el.style.display = 'none');

            // IMPORTANTE: esconder apenas a coluna "AÃ‡Ã•ES" das tabelas de receitas e despesas,
            // preservando a coluna de valores da tabela de totais.
            ['receitasTable', 'despesasTable'].forEach(id => {
                const table = element.querySelector('#' + id);
                if (!table) return;
                table.querySelectorAll('th:last-child, td:last-child').forEach(cell => {
                    cell.style.display = 'none';
                });
            });

            // 9. GERA PDF
            const opt = {
                margin: 0.5,
                filename: 'balanco-financeiro.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' },
                pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
            };

            html2pdf().set(opt).from(element).save();
        }

        function attachModalEvents() {
            document.querySelectorAll('.totals span[data-modal]').forEach(s => {
                s.addEventListener('click', () => document.getElementById(s.getAttribute('data-modal')).style.display='block');
            });
            document.querySelectorAll('.close').forEach(c => {
                c.addEventListener('click', () => document.getElementById(c.getAttribute('data-close')).style.display='none');
            });
            window.onclick = e => { if(e.target.classList.contains('modal')) e.target.style.display='none'; };
        }
    </script>
</body>
</html>
